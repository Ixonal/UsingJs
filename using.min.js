/*

UsingJs script loader and dependency tracker
Copyright 2013-2016 Benjamin McGregor (Ixonal)
Released under the MIT Licence
http://opensource.org/licenses/MIT
*/
(function(q){function r(a){if(1>=arguments.length)throw Error("At least an extender and extendee are required");var b=arguments[0],c,e,g,f;e=1;for(f=arguments.length;e<f;e++)if(c=arguments[e])for(g in c)b[g]=c[g];return b}function x(a){var b=arguments[0],c,e,g,f,d;if(!b||b.constructor!==y)throw Error("The mergee must be an array.");e=1;for(f=arguments.length;e<f;e++){c=arguments[e];if(!c||c.constructor!==y)throw Error("The merger must be an array.");g=0;for(d=c.length;g<d;g++)b.push(c[g])}return b}
function w(a,b){for(var c=0,e=a.length;c<e;c++)if(a[c].matches(b))return c;return-1}function l(a,b){return null===a?"null":a===q?"undefined":"object"===typeof a?"[object Array]"===Object.prototype.toString.call(a)?b?"array":0<a.length?"array<"+l(a[0])+">":"array<object>":a.constructor===h.RegExp?"regexp":a.constructor===h.Date?"date":a.src?"dependency":"object":typeof a}function H(a){k=r({},P,k,a);if(!k.browser){var b=k,c;c={name:"unknown",version:null};var e,g=3,f,d;if(h.navigator)if(e=Q.exec(h.navigator.userAgent)){f=
t.createElement("div");for(d=f.getElementsByTagName("i");f.innerHTML="\x3c!--[if gt IE "+ ++g+"]><i></i><![endif]--\x3e",d[0];);c.name="ie";c.version=4<g?g:+(e[2]||e[4])}else if(e=R.exec(h.navigator.userAgent))c.name="cr",c.version=+e[1];else if(e=S.exec(h.navigator.userAgent))c.name="ff",c.version=+e[1];else if(e=T.exec(h.navigator.userAgent))c.name="sf",c.version=+e[1];c={browser:c};r(b,c)}k.environment="undefined"!==typeof module&&this.module!==module?"nd":h.document?"wb":"ww";a:{f=t.getElementsByTagName("script");
var n=["using.js","using.min.js",k.srcName],l,b=0;for(e=f.length;b<e;b++)for(d=f[b].src,c=0,g=n.length;c<g;c++)if((l=n[c])&&d.substr(d.length-l.length,l.length)===l){c=f[b];break a}c=null}if(!c)throw Error("Could not locate the using.js script include. \nPlease specify the name of the source file in the configuration.");b=c.getAttribute("data-script-root")||a&&a.scriptRoot||k.scriptRoot;a=c.getAttribute("data-style-root")||a&&a.styleRoot||k.styleRoot;e=c.getAttribute("data-using");c=c.getAttribute("data-using-css");
b&&"/"!==b.substr(b.length-1,1)&&(b+="/");k.scriptRoot=b||"/";a&&"/"!==a.substr(a.length-1,1)&&(a+="/");k.styleRoot=a||"/";e&&(k.initialUsing=h.eval("("+e+")"));c&&(k.initialStyleUsing=h.eval("("+c+")"))}function I(a){k.debug&&h.console&&h.console.warn(a)}function z(a){switch(l(a)){case "string":return U.test(a)?"js":V.test(a)?"css":"js";case "dependency":return"<||page||>"===a.type||"<||usingContext||>"===a.type?"js":a.type||z(a.src)}}function J(a,b){a.substr(a.length-(b.length+1),b.length+1)!==
"."+b&&(a+="."+b);return a}function A(a){var b;switch(l(a,!0)){case "string":a=J(a,"css");break;case "dependency":a.noExtension||(a.src=J(a.src,"css"));a.type="css";break;case "array":for(b=a.length;b--;)a[b]=A(a[b])}return a}function K(){return"ie"===k.browser.name&&10>=k.browser.version}function W(a){if("object"!=typeof a)return!1;if(Object.keys)return 0===Object.keys(a).length;for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}function L(a,b,c){b=b.split(/[\.\/\\]+/);var e,g;e=0;for(g=b.length-
1;e<g;e++)a=a[b[e]]=a[b[e]]||{};a[b[b.length-1]]=c;return a}function u(a,b,c,e,g,d,l){this.src=a;this.type=b||z(a);this.backup=e;this.noExtension=c;this.resolutionCallbacks=[];this.dependencyFor=[];this.dependentOn=[];this.exports={};this.exportProp=l;g&&(this.name=g);this.minified=d!==q?d:k.minified}function B(){if(!C){C=!0;for(var a=D.length;a--;)D[a]()}}function X(){if(!E){E=!0;var a=k.pollingTimeout;setTimeout(function c(){C||(m.testCompleteness()?B():setTimeout(c,a));E=!1},a)}}function F(a,b,
c,e){var g,f,h,n,p,q,r=m.empty();switch(l(a,!0)){case "function":return d.ready(a);case "string":case "dependency":case "array":g=M.resolveAlias(a);break;default:throw Error("Valid dependencies must be entered");}h=[];e?p=e:r||v?((p=m.locatePageDependency())||(p=m.createPageDependency()),8===p.status&&(p.status=4)):K()?p=m.locateInteractiveDependency():"currentScript"in t&&(p=m.locateCurrentScriptDependency());for(f=g.length;f--;){n=m.locateDependency(g[f]);if(!n){switch(l(g[f],!0)){case "string":q=
!1;n=new u(g[f],z(g[f]),!1,null);break;case "dependency":q=g[f].dependsOn,n=new u(g[f].src,z(g[f]),g[f].noExtension,g[f].backup,g[f].name,g[f].minified,g[f].exports)}m.addDependency(n);q?function(){var a=n;F(g[f].dependsOn,function(){a.load()},null,a);a.init()}():n.init()}h.push(n)}if(p){for(f=h.length;f--;)p.dependOn(h[f]),e&&h[f].addResolutionCallback(b);b&&!e&&p.addResolutionCallback(b);c&&(p.name=c)}else{a=new u("<||usingContext||>"+Y++,"<||usingContext||>",a.noExtension,a.backup,c,a.minified);
m.addDependency(a);for(f=h.length;f--;)a.dependOn(h[f]);b&&a.addResolutionCallback(b);c&&(a.name=c);a.init();r||v||K()||N.push(a)}"ie"===k.browser.name&&X()}function d(a,b){F(a,b);return d}var h=this||(0,eval)("this"),k=h.using?h.using.config:null,y=h.Array,P={noConflict:!1,scriptRoot:"/",styleRoot:"/",cached:!0,pollingTimeout:200,minified:!1,debug:!1},N=[],v=!1,t=h.document,Q=/(MSIE\s*(\d+))|(rv:(\d+\.?\d*))/i,R=/Chrome\/(\d+)/i,S=/Firefox\/(\d+)/i,T=/Safari\/(\d+)/i,U=/\.((js)|(jscript))$/i,V=/\.(css)$/i,
O=/([a-zA-Z0-9\.]*:)?\/\/([^\/]+)\/?/,G={8:!0,5:!0,6:!0,9:!0};H(k);var M={map:{},locateDependency:function(a){var b,c,e=l(a,!0);for(b in this.map)for(c=this.map[b].length;c--;)switch(e){case "string":switch(l(this.map[b][c],!0)){case "string":if(this.map[b][c]===a)return this.map[b][c];break;case "dependency":if(this.map[b][c].src===a)return this.map[b][c]}break;case "dependency":switch(l(this.map[b][c],!0)){case "string":if(this.map[b][c]===a.src)return this.map[b][c];break;case "dependency":var g=
this.map[b][c];if(g.src===a.src&&g.type===a.type&&g.conditionally===a.conditionally&&g.dependsOn===a.dependsOn&&g.noExtension===a.noExtension&&g.backup===a.backup)return this.map[b][c]}}return null},addAlias:function(a,b){if("string"!==l(a))throw Error("The alias must be a string.");var c;c=l(b,!0);var e;if(a===b)throw Error("Mapping to an equivalently named alias is not allowed.");if("dependency"===c&&a===b.src)throw Error("Mapping to an equivalently named alias is not allowed.");switch(c){case "array":e=
[];for(c=b.length;c--;)x(e,this.resolveAlias(b[c]));break;case "string":case "dependency":e=this.resolveAlias(b);break;default:throw Error("Unknown dependency type found");}this.map[a]=e;return this},resolveAlias:function(a){var b=[],c,e;switch(l(a,!0)){case "string":if(this.map[a])for(c=0,e=this.map[a].length;c<e;c++)x(b,this.resolveAlias(this.map[a][c]));else return[a];break;case "dependency":return a.conditionally===q||!0===a.conditionally?(b=this.resolveAlias(a.src),0<b.length&&(1!==b.length||
b[0]!==a.src)?b:[a]):b;case "array":if(0===a.length)return b;for(c=a.length;c--;)x(b,this.resolveAlias(a[c]));0===b.length&&x(b,a);break;default:throw Error("Alias is not a recognized type.");}return 0===b.length?[a]:b}};r(u.prototype,{src:null,backup:null,useBackup:!1,type:"js",noExtension:!1,status:0,dependencyFor:null,dependentOn:null,resolutionCallbacks:null,requestObj:null,exports:null,name:null,minified:!1,exportProp:null,destroy:function(){if(6!==this.status){var a;for(a=this.dependencyFor.length;a--;)this.dependencyFor[a].matches(this)&&
this.dependencyFor.splice(a,1);for(a=this.dependentOn.length;a--;)this.dependentOn[a].matches(this)&&this.dependentOn.splice(a,1);delete this.dependencyFor;delete this.dependentOn;delete this.resolutionCallbacks;delete this.requestObj;delete this.requestObj;delete this.src;delete this.backup;delete this.useBackup;delete this.type;this.status=6}},finalize:function(){var a,b;if(4===this.status){this.status=7;for(a=this.dependentOn.length;a--;)8!==this.dependentOn[a].status&&this.dependentOn[a].notify();
for(a=this.resolutionCallbacks.length;a--;)switch(b=this.resolutionCallbacks[a](this.getDependencyExports(),this.exports),l(b,!0)){case "object":r(this.exports,b);break;default:b&&(this.exports=b)}this.status=8;m.emit("dependency-status-terminal");for(a=this.dependencyFor.length;a--;)8!=this.dependencyFor[a].status&&this.dependencyFor[a].notify();"<||page||>"!==this.type&&m.testCompleteness()&&B()}},getDependencyExports:function(){var a,b,c={};for(a=this.dependentOn.length;a--;)if(b=this.dependentOn[a],
!W(b.exports))L(c,b.name||b.src,b.exports);else if(b.exportProp){var e=b.name||b.src;a:{var g=h;b=b.exportProp.split(/[\.\/\\]+/);for(var d=void 0,k=void 0,d=0,k=b.length;d<k;d++)if(g=g[b[d]],g===q){b=null;break a}b=g}L(c,e,b)}return c},notify:function(){if(4===this.status||9===this.status)9===this.status?m.testCompleteness()&&B():this.isReady()&&this.finalize()},isReady:function(a){var b;if(8===this.status)return!0;if(4!==this.status)return!1;a=a||[];a.push(this);for(var c=this.dependentOn.length-
1;0<=c;c--){b=this.dependentOn[c];var e;a:{e=a;var d=b;if(y.prototype.indexOf)e=y.prototype.indexOf.apply(e,d);else{for(var f=0,h=e.length;f<h;f++)if(e[f]===d){e=f;break a}e=-1}}if(-1!==e){if(k.debug){e="Cyclic dependency found (non-terminal): \n";for(d=0;d<a.length;d++)e+=a[d]===b?"---\x3e":"    ",e+=(a[d].name||a[d].src)+"\n";e+="---\x3e"+(b.name||b.src);I(e)}}else if(!b.isReady(a))return!1}return!0},dependOn:function(a){if(!a||a.constructor!==u)throw Error("The other dependency must be a valid Dependency object.");
this.matches(a)||(-1===w(this.dependentOn,a)&&(a.dependencyFor.push(this),this.dependentOn.push(a)),4===a.status&&this.notify())},addResolutionCallback:function(a){if("function"!==l(a))throw Error("dependency resolution callback function must be a function.");7===this.status||8===this.status?a():this.resolutionCallbacks.push(a)},matches:function(a){var b=l(a);return"string"===b?this.src===a:"dependency"===b?this.src===a.src&&this.type==a.type:!1},removeDependencyOn:function(a){if(!this.matches(a)){var b=
w(this.dependentOn,a);0<=b&&this.dependentOn.splice(b,1);b=w(a.dependencyFor,this);0<=b&&a.dependencyFor.splice(b,1)}},resolve:function(){if(3===this.status){for(var a,b,c;(b=N.shift())!==q;)if("<||usingContext||>"===b.type&&6!==b.status){b.name&&(this.name=b.name);b.noExtension&&(this.noExtension=b.noExtension);b.minified!==q&&(this.minified=b.minified);for(a=b.dependentOn.length;a--;)c=b.dependentOn[a],this.dependOn(c),b.removeDependencyOn(c);for(a=b.resolutionCallbacks.length;a--;)this.addResolutionCallback(b.resolutionCallbacks[a]);
m.removeDependency(b)}this.status=4;this.notify()}},error:function(a){var b,c;this.status=9;m.emit("dependency-status-terminal");b=this.useBackup?this.backup:this.src;"<||page||>"===b&&(b="page");"<||usingContext||>"===b&&(b="using context");c="UsingJs: An error has occurred when loading "+b;a&&(b=a.useBackup?a.backup:a.src,"<||page||>"===b&&(b="page"),"<||usingContext||>"===b&&(b="using context"),c+=" - dependency "+b+" registered an error");k.debug&&h.console&&h.console.error(c);for(a=this.dependencyFor.length;a--;)b=
this.dependencyFor[a],b.status in G||b.error(this);this.notify()},resolveSourceLocation:function(){var a=""+(this.useBackup?this.backup:this.src),b=(new Date).getTime(),c;(c=a)?(O.lastIndex=0,c=(c=O.exec(c))?h.location?c[1]!==h.location.protocol||c[2]!==h.location.host:!0:!1):c=!1;if(c)return a+(k.cached?"":(-1===a.indexOf("?")?"?_t=":"&_t=")+b);!this.noExtension&&this.minified&&-1===a.indexOf("min")&&(a+=".min");this.noExtension||"<||usingContext||>"===this.type||"<||page||>"===this.type||a.substr(a.length-
this.type.length)===this.type||(a+="."+this.type);"/"===a.substr(0,1)&&(a=a.substr(1));k.cached&&k.version&&(a+=(0<=a.indexOf("?")?"&":"?")+"_v="+encodeURIComponent(k.version));k.cached||(a+=(0<=a.indexOf("?")?"&":"?")+"_t="+b);switch(this.type){case "js":return k.scriptRoot+a;case "css":return k.styleRoot+a;default:return"/"+a}},load:function(){var a=this,b,c;if(1===a.status){for(b=a.dependentOn.length;b--;){c=a.dependentOn[b];if(2===c.status||1===c.status)return;9===c.status&&c.error()}a.status=
2;if("wb"==k.environment){if("js"===a.type)a.requestObj=t.createElement("script"),a.requestObj.setAttribute("src",a.resolveSourceLocation()),a.requestObj.setAttribute("type","text/javascript"),a.requestObj.setAttribute("defer","false"),a.requestObj.setAttribute("async","true");else if("css"===a.type)a.requestObj=t.createElement("link"),a.requestObj.setAttribute("type","text/css"),a.requestObj.setAttribute("href",a.resolveSourceLocation()),a.requestObj.setAttribute("rel","stylesheet");else throw Error("Attempting to load an unsupported file type: "+
a.type);b=function(){a.backup&&!a.useBackup?(I("Error occurred while loading "+a.src+", attempting to load "+a.backup),a.useBackup=!0,a.status=1,a.load()):a.error()};a.requestObj.addEventListener?(a.requestObj.addEventListener("load",function(){a.status=3;a.resolve()},!0),a.requestObj.addEventListener("error",b,!0)):"ie"===k.browser.name&&9>k.browser.version?(a.requestObj.onreadystatechange=function(){if("complete"===a.requestObj.readyState||"loaded"===a.requestObj.readyState)a.requestObj.onreadystatechange=
null,a.status=3,a.resolve()},a.requestObj.attachEvent&&a.requestObj.attachEvent("onerror",b)):a.error("Unable to properly attach events with the current browser configuration.");t.getElementsByTagName("head")[0].appendChild(a.requestObj)}else throw Error("This functionality is not yet implemented");}},init:function(){0===this.status&&("<||usingContext||>"!==this.type&&"<||page||>"!==this.type?(this.status=1,this.load()):(this.status=4,this.notify()))}});var m={_dependencies:{},_dependencyCount:0,
getNumTotalDependencies:function(a){function b(a){var d=1,f,k=a.dependentOn.length,h;for(f=0;f<k;f++)h=a.dependentOn[f],-1===w(c,h)&&(d+=b(h)),c.push(h);return d}if(!a)return this._dependencyCount;a=this.locateDependency(a);var c=[];return b(a)},getNumTerminalDependencies:function(a){function b(a){var d=a.status in G?1:0,f,k=a.dependentOn.length,h;for(f=0;f<k;f++)h=a.dependentOn[f],-1===w(c,h)&&(d+=b(h)),c.push(h);return d}a=a?this.locateDependency(a):this.locatePageDependency();var c=[];return b(a)},
_handlers:{},on:function(a,b){this._handlers[a]||(this._handlers[a]=[]);this._handlers[a].push(b)},emit:function(a,b){var c=this._handlers[a];if(c)for(var d=0,g=c.length;d<g;d++)c[d].call(null,r({},b))},empty:function(){return 0===this._dependencyCount},locatePageDependency:function(){return this._dependencies["<||page||>"]},createPageDependency:function(){var a=new u("<||page||>","<||page||>");this.addDependency(a);a.init();return a},locateInteractiveDependency:function(){var a,b;for(a in this._dependencies)if(b=
this._dependencies[a],b.requestObj&&"interactive"===b.requestObj.readyState)return b;return null},locateCurrentScriptDependency:function(){var a,b,c=t.currentScript;if(!c.src)return null;for(a in this._dependencies)if(b=this._dependencies[a],b.requestObj&&b.requestObj===c)return b;return null},locateDependency:function(a){switch(l(a)){case "string":return this._dependencies[a]||null;case "dependency":return this._dependencies[a.src]?this._dependencies[a.src].type===(a.type||"js")?this._dependencies[a.src]:
null:null;default:return null}},addDependency:function(a){if(!this.locateDependency(a)){var b;switch(l(a)){case "string":b=new u(a,"js");b.init();this._dependencies[a]=b;break;case "dependency":this._dependencies[a.src]=a}}this._dependencyCount++;return this},removeDependency:function(a){switch(l(a)){case "string":return a=this.locateDependency(a),this.removeDependency(a);case "dependency":delete this._dependencies[a.src],a.destroy()}this._dependencyCount--;return this},testCompleteness:function(){var a,
b;for(a=this._dependencies.length;a--;)if(b=this._dependencies[a].status,b in G)return!1;return!0}},D=[],C=!1,E=!1,Y=0;d.amd=function(a,b,c){2===arguments.length&&(c=b,b=a,a=null);F(b,c,a);return d};d.amd=d.amd;d.page=function(a,b){v=!0;switch(l(a,!0)){case "function":a.call(h);break;default:d(a,b)}v=!1;return d};d.page=d.page;d.page.css=function(a,b){v=!0;switch(l(a,!0)){case "function":a.call(h);break;default:d.css(a,b)}v=!1;return d};d.page.css=d.page.css;d.page.progress=function(a){if("function"!==
typeof a)throw Error("callback must be a function");m.on("dependency-status-terminal",function(){a.call(null,m.getNumTotalDependencies(),m.getNumTerminalDependencies())})};d.page.progress=d.page.progress;d.ready=function(a){D.push(a);return d};d.ready=d.ready;d.config=function(a){H(a);return d};d.config=d.config;d.conditionally=function(a,b,c){a&&d(b,c);return d};d.conditionally=d.conditionally;d.alias=function(a,b){M.addAlias(a,b);return d};d.alias=d.alias;d.css=function(a,b){var c;switch(l(a,!0)){case "string":case "dependency":return d(A(a),
b);case "array":for(c=a.length;c--;)a[c]=A(a[c]);return d(a,b);default:throw Error("Valid dependencies must be entered");}};d.css=d.css;d.css.conditionally=function(a,b,c){a&&d.css(b,c);return d};d.css.conditionally=d.css.conditionally;d.css.alias=function(a,b){return d.alias(a,A(b))};d.css.alias=d.css.alias;k.noConflict||(h.using=d);k.initialUsing&&d.page(k.initialUsing);k.initialStyleUsing&&d.page.css(k.initialStyleUsing);return d})();
