/*
UsingJs script loader and dependency tracker
Copyright 2013 Benjamin McGregor
Released under the MIT Licence
*/
(function(g,h){function C(){if(1>=arguments.length)throw Error("At least an extender and extendee are required");var a=arguments[0],b,c,d;for(c=1;c<arguments.length;c++)if(b=arguments[c])for(d in b)a[d]=b[d];return a}function w(){var a=arguments[0],b,c,d;if(!a||a.constructor!==Array)throw Error("The mergee must be an array.");for(c=1;c<arguments.length;c++){b=arguments[c];if(!b||b.constructor!==Array)throw Error("The merger must be an array.");if(b)for(d=0;d<b.length;d++)a.push(b[d])}}function x(a,
b){for(var c=0;c<a.length;c++)if(a[c].matches(b))return c;return-1}function k(a,b){return typeof a===D?a.constructor===g.Array?b?q:0<a.length?q+"<"+k(a[0])+">":q+"<object>":a.constructor===g.RegExp?J:a.constructor===g.Date?K:a.src?l:D:typeof a}function E(){var a=C,b=L,c=h,d;if(g.navigator){d={name:M,version:null};var e;if(e=N.exec(g.navigator.userAgent))d.name=y,d.version=+e[1];else if(e=O.exec(g.navigator.userAgent))d.name=P,d.version=+e[1];else if(e=Q.exec(g.navigator.userAgent))d.name=R,d.version=
+e[1];else if(e=S.exec(g.navigator.userAgent))d.name=T,d.version=+e[1];d={g:d}}else d={g:null};h=a({},b,c,d);a:{c=r.getElementsByTagName("script");e=["using.js","using.min.js",h.P];for(a=0;a<c.length;a++)for(d=c[a].src,b=0;b<e.length;b++)if(d.substr(d.length-e[b].length,e[b].length)===e[b]){d=c[a];break a}d=null}if(null===d)throw Error("Could not locate the using.js script include. \nPlease specify the name of the source file in the configuration.");a=d.getAttribute("data-script-root");b=d.getAttribute("data-style-root");
c=d.getAttribute("data-using");d=d.getAttribute("data-using-css");a&&"/"!==a.substr(a.length-1,1)&&(a+="/");h.C=a||"/";b&&"/"!==b.substr(b.length-1,1)&&(b+="/");h.F=b||"/";c&&(h.v=g.eval("("+c+")"));d&&(h.u=g.eval("("+d+")"))}function F(a,b){var c=""+a,d;d=c&&(7<=c.length&&"http://"===c.substr(0,7).toLowerCase()||8<=c.length&&"https://"===c.substr(0,8).toLowerCase())?g.location?(d=U.exec(c))&&(d[1]!==g.location.protocol||d[2]!==g.location.host):!0:!1;if(d)return c;c.substr(c.length-b.length)===b||
(c+="."+b);"/"===c.substr(0,1)&&(c=c.substr(1));switch(b){case m:return h.C+c;case p:return h.F+c;default:return"/"+c}}function G(a){switch(k(a)){case n:return V.test(a)?m:W.test(a)?p:m;case l:return a.type||m}}function H(a,b){a.substr(a.length-(b.length+1),b.length+1)!=="."+b&&(a+="."+b);return a}function u(a){var b;switch(k(a,!0)){case n:a=H(a,p);break;case l:a.noExtension||(a.src=H(a.src,p));a.type=p;break;case q:for(b=a.length-1;0<=b;b--)a[b]=u(a[b])}return a}function s(a,b,c){this.src=a;this.type=
b||m;this.o=c;this.f=[];this.d=[];this.b=[]}function f(a,b,c){var d,e,g,m,p,r=t.empty();switch(k(a,!0)){case "function":return f.A(a);case n:case l:case q:d=I.k(a);break;default:throw Error("Valid dependencies must be entered");}a=[];r?(m=new s(z,z),m.i()):c?m=c:h.g.name===y&&10>=h.g.version&&(m=t.J());for(e=d.length-1;0<=e;e--){g=t.n(d[e]);if(!g){switch(k(d[e],!0)){case n:p=!1;g=new s(d[e],G(d[e]),!1);break;case l:p=d[e].r,g=new s(d[e].src,G(d[e]),d[e].o)}t.t(g);p?function(){var a=g;f(d[e].r,function(){a.i()},
a)}():g.i()}a.push(g)}if(m){for(e=a.length-1;0<=e;e--)m.q(a[e]),c&&a[e].l(b);b&&!c&&m.l(b)}else{c=new s(v+X++,v);t.t(c);for(e=a.length-1;0<=e;e--)c.q(a[e]);b&&c.l(b);c.i();r||A.push(c)}return f}var L={K:!1,C:"/",F:"/"},A=[],r=g.document,D="object",n="string",q="array",l="dependency",K="date",J="regexp",m="js",p="css",v="usingContext",z="page",N=/MSIE\s*(\d+)/i,O=/Chrome\/(\d+)/i,Q=/Firefox\/(\d+)/i,S=/Safari\/(\d+)/i,V=/\.((js)|(jscript))$/i,W=/\.(css)$/i,U=/([a-zA-Z0-9\.]*:)\/\/([^\/]+)\/?/,M="unknown",
y="ie",R="ff",P="cr",T="sf";E();var I={map:{},n:function(a){var b,c,d=k(a,!0);for(b in this.map)for(c=this.map[b].length-1;0<=c;c--)switch(d){case n:switch(k(this.map[b][c],!0)){case n:if(this.map[b][c]===a)return this.map[b][c];break;case l:if(this.map[b][c].src===a)return this.map[b][c]}break;case l:switch(k(this.map[b][c],!0)){case n:if(this.map[b][c]===a.src)return this.map[b][c];break;case l:if(this.map[b][c].src===a.src&&this.map[b][c].type===a.type&&this.map[b][c].h===a.h&&this.map[b][c].r===
a.r&&this.map[b][c].o===a.o)return this.map[b][c]}}return null},G:function(a,b){if(k(a)!==n)throw Error("The alias must be a string.");var c;c=k(b,!0);var d;if(a===b)throw Error("Mapping to an equivalently named alias is not allowed.");if(c===l&&a===b.src)throw Error("Mapping to an equivalently named alias is not allowed.");switch(c){case q:d=[];for(c=b.length-1;0<=c;c--)w(d,this.k(b[c]));break;case n:case l:d=this.k(b)}this.map[a]=d;return this},k:function(a){var b=[],c;switch(k(a,!0)){case n:if(this.map[a])for(c=
0;c<this.map[a].length;c++)w(b,this.k(this.map[a][c]));else return[a];break;case l:return[a];case q:for(c=a.length-1;0<=c;c--)w(b,this.k(a[c]));break;default:throw Error("Alias is not a recognized type.");}return 0===b.length?[a]:b}};C(s.prototype,{src:null,type:m,o:!1,D:!1,status:0,d:null,b:null,f:null,a:null,I:function(){if(6!==this.status){var a;for(a=this.d.length-1;0<=a;a--)this.d[a].matches(this)&&this.d.splice(a,1);for(a=this.b.length-1;0<=a;a--)this.b[a].matches(this)&&this.b.splice(a,1);
delete this.d;delete this.b;delete this.f;delete this.a;delete this.a;delete this.src;delete this.type;delete this.D;this.status=6}},j:function(){if(4===this.status){var a;if(this.w()){this.status=7;for(a=0;a<this.b.length;a++)this.b[a].j();for(a=0;a<this.f.length;a++)this.f[a]();for(a=0;a<this.d.length;a++)this.d[a].j();if(t.M())for(a=0;a<B.length;a++)B[a]()}}},w:function(){if(4!==this.status&&7!==this.status)return!1;for(var a=this.b.length-1;0<=a;a--)if(!this.b[a].w())return!1;return!0},q:function(a){if(!a||
a.constructor!==s)throw Error("The other dependency must be a valid Dependency object.");this.matches(a)||(-1===x(this.b,a)&&(a.d.push(this),this.b.push(a)),4===a.status&&this.j())},l:function(a){if("function"!==k(a))throw Error("dependency resolution callback function must be a function.");4===this.Q?a():this.f.push(a)},matches:function(a){var b=k(a);if(b===n)return this.src===a;if(b===l)return this.src===a.src&&this.type==a.type},L:function(a){if(!this.matches(a)){var b=x(this.b,a);0<=b&&this.b.splice(b,
1);b=x(a.d,this);0<=b&&a.d.splice(b,1)}},p:function(){if(3===this.status){var a,b,c,d,e;c=A.splice(0,A.length);for(a=0;a<c.length;a++)if(d=c[a],d.type===v&&6!==d.status){for(b=d.b.length-1;0<=b;b--)e=d.b[b],this.q(e),d.L(e);for(b=d.f.length-1;0<=b;b--)this.l(d.f[b]);t.B(d)}this.status=4;6!==this.status&&this.j()}},load:function(){var a=this;a.status=2;if(a.type===m)a.a=r.createElement("script"),a.a.src=F(a.src,a.type),a.a.type="text/javascript",a.a.defer=!1,a.a.async=!0;else if(a.type===p)a.a=r.createElement("link"),
a.a.type="text/css",a.a.href=F(a.src,a.type),a.a.rel="stylesheet";else throw Error("Attempting to load an unsupported file type: "+this.type);h.g.name===y&&9>h.g.version?a.a.onreadystatechange=function(){if("complete"===a.a.readyState||"loaded"===a.a.readyState)a.a.onreadystatechange=null,a.status=3,a.p()}:a.a.addEventListener("load",function(){a.status=3;a.p()},!0);r.getElementsByTagName("head")[0].appendChild(this.a)},i:function(){0===this.status&&(this.status=1,this.type!==v&&this.type!==z?this.load():
this.j())}});var t={c:{},s:0,N:function(){for(var a in this.c)this.c[a].D=!1},empty:function(){return 0===this.s},J:function(){var a,b;for(a in this.c)if(b=this.c[a],b.a&&"interactive"===b.a.readyState)return b;return null},n:function(a){switch(k(a)){case n:return this.c[a]||null;case l:return this.c[a.src]||null;default:return null}},t:function(a){if(!this.n(a)){var b;switch(k(a)){case n:b=new s(a,m);b.i();this.c[a]=b;break;case l:this.c[a.src]=a}}this.s++;return this},B:function(a){switch(k(a)){case n:return this.B(this.n(a));
case l:delete this.c[a.src],a.I()}return this},p:function(){for(var a in this.c)this.c[a].O||this.c[a].p()},M:function(){var a,b;for(a in this.c)if(b=this.c[a].status,7!==b&&5!==b&&6!==b)return!1;return!0}},B=[],X=0;f.A=function(a){B.push(a)};f.ready=f.A;f.H=function(){E();return f};f.config=f.H;f.h=function(a,b,c){a&&f(b,c);return f};f.conditionally=f.h;f.m=function(a,b){I.G(a,b);return f};f.alias=f.m;f.e=function(a,b){var c;switch(k(a,!0)){case n:case l:return f(u(a),b);case q:for(c=a.length-1;0<=
c;c--)a[c]=u(a[c]);return f(a,b);default:throw Error("Valid dependencies must be entered");}};f.css=f.e;f.e.h=function(a,b,c){a&&f.e(b,c);return f};f.css.conditionally=f.e.h;f.e.m=function(a,b){return f.m(a,u(b))};f.css.alias=f.e.m;h.K||(g.using=f);h.v&&f(h.v);h.u&&f.e(h.u);return f})(window||global,(window||global).using?using.configuration:null);
