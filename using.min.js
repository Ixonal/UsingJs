/*
UsingJs script loader and dependency tracker
Copyright 2013 Benjamin McGregor (Ixonal)
Released under the MIT Licence
http://opensource.org/licenses/MIT
*/
(function(g,h){function E(a){if(1>=arguments.length)throw Error("At least an extender and extendee are required");var b=arguments[0],c,e,d;for(e=1;e<arguments.length;e++)if(c=arguments[e])for(d in c)b[d]=c[d];return b}function x(a){var b=arguments[0],c,e,d;if(!b||b.constructor!==Array)throw Error("The mergee must be an array.");for(e=1;e<arguments.length;e++){c=arguments[e];if(!c||c.constructor!==Array)throw Error("The merger must be an array.");if(c)for(d=0;d<c.length;d++)b.push(c[d])}}function y(a,
b){for(var c=0;c<a.length;c++)if(a[c].matches(b))return c;return-1}function k(a,b){return typeof a===F?a.constructor===g.Array?b?r:0<a.length?r+"<"+k(a[0])+">":r+"<object>":a.constructor===g.RegExp?M:a.constructor===g.Date?N:a.src?l:F:typeof a}function G(a){var b=E,c=O,e=h,d;if(g.navigator){d={name:P,version:null};var f;if(f=Q.exec(g.navigator.userAgent))d.name=u,d.version=+f[1];else if(f=R.exec(g.navigator.userAgent))d.name=S,d.version=+f[1];else if(f=T.exec(g.navigator.userAgent))d.name=U,d.version=
+f[1];else if(f=V.exec(g.navigator.userAgent))d.name=W,d.version=+f[1];d={browser:d}}else d={browser:null};h=b({},c,e,a,d);a:{c=s.getElementsByTagName("script");d=["using.js","using.min.js",h.M];for(a=0;a<c.length;a++)for(e=c[a].src,b=0;b<d.length;b++)if(e.substr(e.length-d[b].length,d[b].length)===d[b]){e=c[a];break a}e=null}if(null===e)throw Error("Could not locate the using.js script include. \nPlease specify the name of the source file in the configuration.");a=e.getAttribute("data-script-root");
b=e.getAttribute("data-style-root");c=e.getAttribute("data-using");e=e.getAttribute("data-using-css");a&&"/"!==a.substr(a.length-1,1)&&(a+="/");h.scriptRoot=a||"/";b&&"/"!==b.substr(b.length-1,1)&&(b+="/");h.styleRoot=b||"/";c&&(h.initialUsing=g.eval("("+c+")"));e&&(h.initialStyleUsing=g.eval("("+e+")"))}function H(a,b,c){a=""+a;var e=(new Date).getTime(),d;d=a&&(7<=a.length&&"http://"===a.substr(0,7).toLowerCase()||8<=a.length&&"https://"===a.substr(0,8).toLowerCase())?g.location?(d=X.exec(a))&&
(d[1]!==g.location.protocol||d[2]!==g.location.host):!0:!1;if(d)return a+(h.cached?"":(-1===a.indexOf("?")?"?_t=":"&_t=")+e);c||a.substr(a.length-b.length)===b||(a+="."+b);"/"===a.substr(0,1)&&(a=a.substr(1));h.cached||(a=-1===a.indexOf("?")?a+("?_t="+e):a+("&_t="+e));switch(b){case m:return h.scriptRoot+a;case p:return h.styleRoot+a;default:return"/"+a}}function I(a){switch(k(a)){case n:return Y.test(a)?m:Z.test(a)?p:m;case l:return a.type||m}}function J(a,b){a.substr(a.length-(b.length+1),b.length+
1)!=="."+b&&(a+="."+b);return a}function v(a){var b;switch(k(a,!0)){case n:a=J(a,p);break;case l:a.noExtension||(a.src=J(a.src,p));a.type=p;break;case r:for(b=a.length-1;0<=b;b--)a[b]=v(a[b])}return a}function K(){return h.browser.name===u&&10>=h.browser.version}function t(a,b,c){this.src=a;this.type=b||m;this.p=c;this.f=[];this.d=[];this.b=[]}function z(){if(!A){A=!0;for(var a=0;a<B.length;a++)B[a]()}}function $(){var a=h.pollingTimeout;setTimeout(function c(){A||(q.q()?z():setTimeout(c,a))},a)}
function f(a,b,c){var e,d,g,m,p,s=q.empty();switch(k(a,!0)){case "function":return f.u(a);case n:case l:case r:e=L.i(a);break;default:throw Error("Valid dependencies must be entered");}a=[];s?(m=new t(C,C),m.h()):c?m=c:K()&&(m=q.H());for(d=e.length-1;0<=d;d--){g=q.l(e[d]);if(!g){switch(k(e[d],!0)){case n:p=!1;g=new t(e[d],I(e[d]),!1);break;case l:p=e[d].dependsOn,g=new t(e[d].src,I(e[d]),e[d].noExtension)}q.s(g);p?function(){var a=g;f(e[d].dependsOn,function(){a.load()},a);a.h()}():g.h()}a.push(g)}if(m){for(d=
a.length-1;0<=d;d--)m.o(a[d]),c&&a[d].j(b);b&&!c&&m.j(b)}else{c=new t(w+aa++,w);q.s(c);for(d=a.length-1;0<=d;d--)c.o(a[d]);b&&c.j(b);c.h();s||K()||D.push(c)}h.browser.name===u&&$();return f}var O={noConflict:!1,scriptRoot:"/",styleRoot:"/",cached:!0,pollingTimeout:200},D=[],s=g.document,F="object",n="string",r="array",l="dependency",N="date",M="regexp",m="js",p="css",w="usingContext",C="page",Q=/MSIE\s*(\d+)/i,R=/Chrome\/(\d+)/i,T=/Firefox\/(\d+)/i,V=/Safari\/(\d+)/i,Y=/\.((js)|(jscript))$/i,Z=/\.(css)$/i,
X=/([a-zA-Z0-9\.]*:)\/\/([^\/]+)\/?/,P="unknown",u="ie",U="ff",S="cr",W="sf";G(h);var L={map:{},l:function(a){var b,c,e=k(a,!0);for(b in this.map)for(c=this.map[b].length-1;0<=c;c--)switch(e){case n:switch(k(this.map[b][c],!0)){case n:if(this.map[b][c]===a)return this.map[b][c];break;case l:if(this.map[b][c].src===a)return this.map[b][c]}break;case l:switch(k(this.map[b][c],!0)){case n:if(this.map[b][c]===a.src)return this.map[b][c];break;case l:if(this.map[b][c].src===a.src&&this.map[b][c].type===
a.type&&this.map[b][c].conditionally===a.conditionally&&this.map[b][c].dependsOn===a.dependsOn&&this.map[b][c].noExtension===a.noExtension)return this.map[b][c]}}return null},A:function(a,b){if(k(a)!==n)throw Error("The alias must be a string.");var c;c=k(b,!0);var e;if(a===b)throw Error("Mapping to an equivalently named alias is not allowed.");if(c===l&&a===b.src)throw Error("Mapping to an equivalently named alias is not allowed.");switch(c){case r:e=[];for(c=b.length-1;0<=c;c--)x(e,this.i(b[c]));
break;case n:case l:e=this.i(b)}this.map[a]=e;return this},i:function(a){var b=[],c;switch(k(a,!0)){case n:if(this.map[a])for(c=0;c<this.map[a].length;c++)x(b,this.i(this.map[a][c]));else return[a];break;case l:return[a];case r:if(0===a.length)return b;for(c=a.length-1;0<=c;c--)x(b,this.i(a[c]));break;default:throw Error("Alias is not a recognized type.");}return 0===b.length?[a]:b}};E(t.prototype,{src:null,type:m,p:!1,w:!1,status:0,d:null,b:null,f:null,a:null,C:function(){if(6!==this.status){var a;
for(a=this.d.length-1;0<=a;a--)this.d[a].matches(this)&&this.d.splice(a,1);for(a=this.b.length-1;0<=a;a--)this.b[a].matches(this)&&this.b.splice(a,1);delete this.d;delete this.b;delete this.f;delete this.a;delete this.a;delete this.src;delete this.type;delete this.w;this.status=6}},D:function(){var a;if(4===this.status){this.status=7;for(a=0;a<this.b.length;a++)8!==this.b[a].status&&this.b[a].g();for(a=0;a<this.f.length;a++)this.f[a]();this.status=8;for(a=0;a<this.d.length;a++)8!=this.d[a].status&&
this.d[a].g();q.q()&&z()}},g:function(){if(4===this.status||9===this.status)this.t()?this.D():9===this.status&&q.q()&&z()},t:function(){var a;if(8===this.status)return!0;if(4!==this.status)return!1;for(var b=this.b.length-1;0<=b;b--)if(a=this.b[b],!a.t())return!1;return!0},o:function(a){if(!a||a.constructor!==t)throw Error("The other dependency must be a valid Dependency object.");if("../Source.aspx/Images"===this.src)debugger;this.matches(a)||(-1===y(this.b,a)&&(a.d.push(this),this.b.push(a)),4===
a.status&&this.g())},j:function(a){if("function"!==k(a))throw Error("dependency resolution callback function must be a function.");4===this.N?a():this.f.push(a)},matches:function(a){var b=k(a);if(b===n)return this.src===a;if(b===l)return this.src===a.src&&this.type==a.type},I:function(a){if(!this.matches(a)){var b=y(this.b,a);0<=b&&this.b.splice(b,1);b=y(a.d,this);0<=b&&a.d.splice(b,1)}},m:function(){if(3===this.status){var a,b,c,e,d;c=D.splice(0,D.length);for(a=0;a<c.length;a++)if(e=c[a],e.type===
w&&6!==e.status){for(b=e.b.length-1;0<=b;b--)d=e.b[b],this.o(d),e.I(d);for(b=e.f.length-1;0<=b;b--)this.j(e.f[b]);q.v(e)}this.status=4;6!==this.status&&this.g()}},error:function(a){var b;this.status=9;b="UsingJs: An error has occurred when loading "+this.src;a&&(b+=" - dependency "+a.src+" registered an error");g.console&&g.console.error(b);for(a=this.d.length-1;0<=a;a--)b=this.d[a],9!==b.status&&5!==b.status&&8!==b.status&&b.error(this);this.g()},load:function(){var a=this,b,c;if(1===this.status){for(b=
a.b.length-1;0<=b;b--){c=a.b[b];if(2===c.status||1===c.status)return;9===c.status&&c.error()}a.status=2;if(a.type===m)a.a=s.createElement("script"),a.a.setAttribute("src",H(a.src,a.type,a.p)),a.a.setAttribute("type","text/javascript"),a.a.setAttribute("defer","false"),a.a.setAttribute("async","true");else if(a.type===p)a.a=s.createElement("link"),a.a.setAttribute("type","text/css"),a.a.setAttribute("href",H(a.src,a.type,a.p)),a.a.setAttribute("rel","stylesheet");else throw Error("Attempting to load an unsupported file type: "+
a.type);h.browser.name===u&&9>h.browser.version?(a.a.onreadystatechange=function(){if("complete"===a.a.readyState||"loaded"===a.a.readyState)a.a.onreadystatechange=null,a.status=3,a.m()},a.a.attachEvent&&a.a.attachEvent("onerror",function(){a.error()})):(a.a.addEventListener("load",function(){a.status=3;a.m()},!0),a.a.addEventListener("error",function(){a.error()},!0));s.getElementsByTagName("head")[0].appendChild(a.a)}},h:function(){0===this.status&&(this.status=1,this.type!==w&&this.type!==C?this.load():
this.g())}});var q={c:{},r:0,J:function(){for(var a in this.c)this.c[a].w=!1},empty:function(){return 0===this.r},H:function(){var a,b;for(a in this.c)if(b=this.c[a],b.a&&"interactive"===b.a.readyState)return b;return null},l:function(a){switch(k(a)){case n:return this.c[a]||null;case l:return this.c[a.src]||null;default:return null}},s:function(a){if(!this.l(a)){var b;switch(k(a)){case n:b=new t(a,m);b.h();this.c[a]=b;break;case l:this.c[a.src]=a}}this.r++;return this},v:function(a){switch(k(a)){case n:return this.v(this.l(a));
case l:delete this.c[a.src],a.C()}return this},m:function(){for(var a in this.c)this.c[a].K||this.c[a].m()},q:function(){var a,b;for(a in this.c)if(b=this.c[a].status,8!==b&&5!==b&&6!==b&&9!==b)return!1;return!0}},B=[],A=!1,aa=0;f.u=function(a){B.push(a)};f.ready=f.u;f.B=function(a){G(a);return f};f.config=f.B;f.n=function(a,b,c){a&&f(b,c);return f};f.conditionally=f.n;f.k=function(a,b){L.A(a,b);return f};f.alias=f.k;f.e=function(a,b){var c;switch(k(a,!0)){case n:case l:return f(v(a),b);case r:for(c=
a.length-1;0<=c;c--)a[c]=v(a[c]);return f(a,b);default:throw Error("Valid dependencies must be entered");}};f.css=f.e;f.e.n=function(a,b,c){a&&f.e(b,c);return f};f.css.conditionally=f.e.n;f.e.k=function(a,b){return f.k(a,v(b))};f.css.alias=f.e.k;h.L||(g.using=f);h.G&&f(h.G);h.F&&f.e(h.F);return f})(window||global,(window||global).using?using.configuration:null);
